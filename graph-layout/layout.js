const data = {"nodes":[{"versionKey":{"system":"PYPI","name":"tensorflow","version":"2.12.0"},"bundled":false,"relation":"SELF","errors":[]},{"versionKey":{"system":"PYPI","name":"absl-py","version":"1.4.0"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"astunparse","version":"1.6.3"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"cachetools","version":"5.3.0"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"certifi","version":"2023.5.7"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"charset-normalizer","version":"3.1.0"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"flatbuffers","version":"23.5.9"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"gast","version":"0.4.0"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"google-auth","version":"2.18.1"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"google-auth-oauthlib","version":"1.0.0"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"google-pasta","version":"0.2.0"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"grpcio","version":"1.55.0"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"h5py","version":"3.8.0"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"idna","version":"3.4.0"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"importlib-metadata","version":"6.6.0"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"jax","version":"0.4.10"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"keras","version":"2.12.0"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"libclang","version":"16.0.0"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"markdown","version":"3.4.3"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"markupsafe","version":"2.1.2"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"numpy","version":"1.23.5"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"oauthlib","version":"3.2.2"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"opt-einsum","version":"3.3.0"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"packaging","version":"23.1.0"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"protobuf","version":"4.23.1"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"pyasn1","version":"0.5.0"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"pyasn1-modules","version":"0.3.0"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"requests","version":"2.31.0"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"requests-oauthlib","version":"1.3.1"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"rsa","version":"4.9.0"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"setuptools","version":"67.8.0"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"six","version":"1.16.0"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"tensorboard","version":"2.12.3"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"tensorboard-data-server","version":"0.7.0"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"tensorflow-estimator","version":"2.12.0"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"tensorflow-io-gcs-filesystem","version":"0.32.0"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"termcolor","version":"2.3.0"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"typing-extensions","version":"4.6.1"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"urllib3","version":"1.26.16"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"werkzeug","version":"2.3.4"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"wheel","version":"0.40.0"},"bundled":false,"relation":"INDIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"wrapt","version":"1.14.1"},"bundled":false,"relation":"DIRECT","errors":[]},{"versionKey":{"system":"PYPI","name":"zipp","version":"3.15.0"},"bundled":false,"relation":"INDIRECT","errors":[]}],"edges":[{"fromNode":0,"toNode":1,"requirement":"\u003e=1.0.0"},{"fromNode":0,"toNode":2,"requirement":"\u003e=1.6.0"},{"fromNode":0,"toNode":6,"requirement":"\u003e=2.0"},{"fromNode":0,"toNode":7,"requirement":"\u003c=0.4.0,\u003e=0.2.1"},{"fromNode":0,"toNode":10,"requirement":"\u003e=0.1.1"},{"fromNode":0,"toNode":11,"requirement":"\u003c2.0,\u003e=1.24.3"},{"fromNode":0,"toNode":12,"requirement":"\u003e=2.9.0"},{"fromNode":0,"toNode":15,"requirement":"\u003e=0.3.15"},{"fromNode":0,"toNode":16,"requirement":"\u003c2.13,\u003e=2.12.0"},{"fromNode":0,"toNode":17,"requirement":"\u003e=13.0.0"},{"fromNode":0,"toNode":20,"requirement":"\u003c1.24,\u003e=1.22"},{"fromNode":0,"toNode":22,"requirement":"\u003e=2.3.2"},{"fromNode":0,"toNode":23,"requirement":""},{"fromNode":0,"toNode":24,"requirement":"!=4.21.0,!=4.21.1,!=4.21.2,!=4.21.3,!=4.21.4,!=4.21.5,\u003c5.0.0dev,\u003e=3.20.3"},{"fromNode":0,"toNode":30,"requirement":""},{"fromNode":0,"toNode":31,"requirement":"\u003e=1.12.0"},{"fromNode":0,"toNode":32,"requirement":"\u003c2.13,\u003e=2.12"},{"fromNode":0,"toNode":34,"requirement":"\u003c2.13,\u003e=2.12.0"},{"fromNode":0,"toNode":35,"requirement":"\u003e=0.23.1"},{"fromNode":0,"toNode":36,"requirement":"\u003e=1.1.0"},{"fromNode":0,"toNode":37,"requirement":"\u003e=3.6.6"},{"fromNode":0,"toNode":41,"requirement":"\u003c1.15,\u003e=1.11.0"},{"fromNode":2,"toNode":31,"requirement":"\u003c2.0,\u003e=1.6.1"},{"fromNode":2,"toNode":40,"requirement":"\u003c1.0,\u003e=0.23.0"},{"fromNode":8,"toNode":3,"requirement":"\u003c6.0,\u003e=2.0.0"},{"fromNode":8,"toNode":26,"requirement":"\u003e=0.2.1"},{"fromNode":8,"toNode":29,"requirement":"\u003c5,\u003e=3.1.4"},{"fromNode":8,"toNode":31,"requirement":"\u003e=1.9.0"},{"fromNode":8,"toNode":38,"requirement":"\u003c2.0"},{"fromNode":9,"toNode":8,"requirement":"\u003e=2.15.0"},{"fromNode":9,"toNode":28,"requirement":"\u003e=0.7.0"},{"fromNode":10,"toNode":31,"requirement":""},{"fromNode":12,"toNode":20,"requirement":"\u003e=1.14.5"},{"fromNode":14,"toNode":42,"requirement":"\u003e=0.5"},{"fromNode":18,"toNode":14,"requirement":"\u003e=4.4"},{"fromNode":22,"toNode":20,"requirement":"\u003e=1.7"},{"fromNode":26,"toNode":25,"requirement":"\u003c0.6.0,\u003e=0.4.6"},{"fromNode":27,"toNode":4,"requirement":"\u003e=2017.4.17"},{"fromNode":27,"toNode":5,"requirement":"\u003c4,\u003e=2"},{"fromNode":27,"toNode":13,"requirement":"\u003c4,\u003e=2.5"},{"fromNode":27,"toNode":38,"requirement":"\u003c3,\u003e=1.21.1"},{"fromNode":28,"toNode":21,"requirement":"\u003e=3.0.0"},{"fromNode":28,"toNode":27,"requirement":"\u003e=2.0.0"},{"fromNode":29,"toNode":25,"requirement":"\u003e=0.1.3"},{"fromNode":32,"toNode":1,"requirement":"\u003e=0.4"},{"fromNode":32,"toNode":8,"requirement":"\u003c3,\u003e=1.6.3"},{"fromNode":32,"toNode":9,"requirement":"\u003c1.1,\u003e=0.5"},{"fromNode":32,"toNode":11,"requirement":"\u003e=1.48.2"},{"fromNode":32,"toNode":18,"requirement":"\u003e=2.6.8"},{"fromNode":32,"toNode":20,"requirement":"\u003e=1.12.0"},{"fromNode":32,"toNode":24,"requirement":"\u003e=3.19.6"},{"fromNode":32,"toNode":27,"requirement":"\u003c3,\u003e=2.21.0"},{"fromNode":32,"toNode":30,"requirement":"\u003e=41.0.0"},{"fromNode":32,"toNode":33,"requirement":"\u003c0.8.0,\u003e=0.7.0"},{"fromNode":32,"toNode":39,"requirement":"\u003e=1.0.1"},{"fromNode":32,"toNode":40,"requirement":"\u003e=0.26"},{"fromNode":39,"toNode":19,"requirement":"\u003e=2.1.1"}],"error":""};


// Function to draw a node
function drawNode(ctx, node, radius) {
    const [x,y] = node.coords;
    ctx.strokeStyle = '#52BE80';
    ctx.fillStyle = '#7DCEA0';
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, Math.PI * 2);
    ctx.stroke();
    ctx.fill();
    
    ctx.strokeStyle = 'darkgray';
    ctx.fillStyle = 'darkgray';
    ctx.fillText(`${node.versionKey.name}`, x, y);
  }
  
// Function to draw nodes
function drawNodes(ctx, data) {
    const nodes = data.nodes;
    const radius = 10;
    nodes.forEach(node => {
        drawNode(ctx, node, radius);          
        console.log(node.coords, node.velocity);
    });
  }

  function calculateAttraction(data) {
    const attractionForce = 0.04;

    const nodes = data.nodes;
    // Attraction forces
    data.edges.forEach(edge => {
    const node1 = nodes[edge.fromNode];
    const node2 = nodes[edge.toNode];

    const [distance, _, dx, dy] = computeDistance(node1, node2);

    // The force magnitude is proportional to the distance
    const forceMagnitude = attractionForce * distance;

    // The force direction is along the vector between the nodes
    const forceDirectionX = dx / (distance || 1);
    const forceDirectionY = dy / (distance || 1);

    // Update the velocities of both nodes
    node1.velocity[0] += forceMagnitude * forceDirectionX;
    node1.velocity[1] += forceMagnitude * forceDirectionY;
    node2.velocity[0] -= forceMagnitude * forceDirectionX;
    node2.velocity[1] -= forceMagnitude * forceDirectionY;
});

  }

function computeDistance(node1, node2) {
    let dx = node2.coords[0] - node1.coords[0];
    let dy = node2.coords[1] - node1.coords[1];

    let distanceSquared = dx * dx + dy * dy;
    let distance = Math.sqrt(distanceSquared);
    return [distance, distanceSquared, dx, dy];
}

function calculateRepulsion(data) {
    const nodes = data.nodes;

    const repulsionForce = 2000;

    for (let i = 0; i < nodes.length; i++) {
        for (let j = i + 1; j < nodes.length; j++) {
            let node1 = nodes[i];
            let node2 = nodes[j];

            let [distance, distanceSquared, dx, dy] =  computeDistance(node1, node2);

            // Compute the repulsion force and apply it
            let repulsion = repulsionForce / distanceSquared;
            // fly to the left
            node1.velocity[0] -= dx / distance * repulsion;
            node1.velocity[1] -= dy / distance * repulsion;
            // fly to the right
            node2.velocity[0] += dx / distance * repulsion;
            node2.velocity[1] += dy / distance * repulsion;
        }
    }
}

function calculateGlobalAttraction(data, size) {
    const globalAttraction = 0.001; // tweak this constant for different effects

    let center = {coords:[size / 2, size / 2]};

    data.nodes.forEach(node => {
        let [distance, _, dx, dy] = computeDistance(node, center);

        let force = -distance * globalAttraction; 

        node.velocity[0] += force * dx / distance;
        node.velocity[1] += force * dy / distance;
    });
}

function initializeNodes(data, size) {
    data.nodes.forEach(node => {
        node.coords = [ Math.random() * size, Math.random() * size ];
        node.velocity = [0, 0];  // adding initial velocity of each node
    });
}
function moveNodes(data, timeStep) {
    // decrease to settle down faster
    const friction = 0.8;

    data.nodes.forEach(node => {
        node.coords[0] += node.velocity[0] * timeStep;
        node.coords[1] += node.velocity[1] * timeStep;

        // optional: apply some friction to the velocities
        node.velocity[0] *= friction;
        node.velocity[1] *= friction;

        if (Math.abs(node.velocity[0]) < 1) node.velocity[0] = 0;
        if (Math.abs(node.velocity[1]) < 1) node.velocity[1] = 0;
    });
}

// Function to layout nodes
function layoutNodes(ctx, data) {
    const size = Math.min(ctx.canvas.clientWidth, ctx.canvas.clientHeight);
    const timeStep = 0.1;
    calculateRepulsion(data);
    calculateAttraction(data);
    calculateGlobalAttraction(data, size);
    moveNodes(data, timeStep);
}

function drawEdges(ctx, data) {
    ctx.strokeStyle = '#EAEDED';
    const nodes = data.nodes;
    data.edges.forEach((edge) => {
        const fromNode = nodes[edge.fromNode];
        const toNode = nodes[edge.toNode];
        ctx.beginPath();
        ctx.moveTo(fromNode.coords[0], fromNode.coords[1]);
        ctx.lineTo(toNode.coords[0], toNode.coords[1]);
        ctx.stroke();
      });
}

function clearCanvas(ctx) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
}

function drawGraph(ctx, data) {
    clearCanvas(ctx);    
    drawEdges(ctx, data);
    drawNodes(ctx, data);
    layoutNodes(ctx, data);
}

function adjustCanvasToDPi(canvas, ctx) {
    const dpi = window.devicePixelRatio;
    
    // Get CSS size
    const styleHeight = +getComputedStyle(canvas).getPropertyValue('height').slice(0, -2);
    const styleWidth = +getComputedStyle(canvas).getPropertyValue('width').slice(0, -2);
    
    // Scale the canvas
    canvas.setAttribute('height', styleHeight * dpi);
    canvas.setAttribute('width', styleWidth * dpi);

    // Now scale the context to counter the fact that we've manually scaled
    // our canvas element.
    ctx.scale(dpi, dpi);
}


document.addEventListener("DOMContentLoaded", function() {
    const canvas = document.getElementById('graphCanvas');
    if (canvas && canvas.getContext) {
        const ctx = canvas.getContext('2d');
        adjustCanvasToDPi(canvas, ctx);
        const size = Math.min(ctx.canvas.clientWidth, ctx.canvas.clientHeight);
        initializeNodes(data, size);  
        let steps = 1000;  
        function animate() {
            drawGraph(ctx, data);
            if (steps-- > 0) requestAnimationFrame(animate);
        }
        animate();
    } else {
      console.error("No canvas found with id 'myCanvas' or canvas.getContext is not a function");
    }
  });
  